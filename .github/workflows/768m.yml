- name: 添加第三方源并强制解决冲突
        run: |
          cd /workdir/immortalwrt
          # 注入源
          echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> feeds.conf.default
          echo "src-git small https://github.com/kenzok8/small" >> feeds.conf.default
          
          ./scripts/feeds update -a
          
          # 深度清理：防止 Multiple packages define
          # 重点删除官方源中与 kenzo 源冲突的包
          rm -rf feeds/packages/lang/golang
          rm -rf feeds/packages/net/smartdns
          rm -rf feeds/packages/net/adguardhome
          rm -rf feeds/luci/applications/luci-app-smartdns
          rm -rf feeds/luci/applications/luci-app-passwall
          rm -rf feeds/luci/applications/luci-app-adguardhome
          
          ./scripts/feeds install -a

      - name: 预配置阶段 (修正 Code 2)
        run: |
          cd /workdir/immortalwrt
          # 强制指定 Golang 版本（某些插件需要）
          sed -i 's/20.03/24.10/g' .config || true
          
          # 写入配置 (500M 空间等)
          cat >> .config <<EOF
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y
          CONFIG_GRUB_IMAGES=y
          CONFIG_GRUB_EFI_IMAGES=y
          CONFIG_TARGET_KERNEL_PARTSIZE=64
          CONFIG_TARGET_ROOTFS_PARTSIZE=1024
          CONFIG_PACKAGE_luci-app-passwall=y
          CONFIG_PACKAGE_luci-app-smartdns=y
          CONFIG_PACKAGE_luci-app-adguardhome=y
          CONFIG_PACKAGE_luci-app-mwan3=y
          CONFIG_PACKAGE_luci-app-syncdial=y
          CONFIG_PACKAGE_luci-app-ddns=y
          CONFIG_PACKAGE_ddns-scripts-cloudflare=y
          CONFIG_PACKAGE_kmod-e1000=y
          CONFIG_PACKAGE_kmod-e1000e=y
          CONFIG_PACKAGE_kmod-igb=y
          CONFIG_PACKAGE_kmod-igc=y
          CONFIG_PACKAGE_ipv6helper=y
          EOF
          
          # 核心步骤：修正依赖关系
          make defconfig

      - name: 强制校验下载 (解决 Hash Mismatch)
        run: |
          cd /workdir/immortalwrt
          # 预先下载所有源码包
          make download -j8
          # 检查并删除 1k 以下的残损包，防止 Code 2
          find dl -size -1k -exec rm -f {} \;
          # 补充下载
          make download -j1 V=s

      - name: 编译 (单线程保底)
        run: |
          cd /workdir/immortalwrt
          # 如果多线程失败，强制单线程运行并输出错误位置
          make -j$(nproc) || make -j1 V=s
