name: Build ImmortalWrt 24.10 x86_64

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_SH: diy.sh

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 释放磁盘空间 (避免 No space left)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          swap: true

      - name: 初始化编译环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses-dev libssl-dev python3-distutils rsync unzip zlib1g-dev swig libpython3-dev
          sudo timedatectl set-timezone "Asia/Shanghai"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: 克隆源码
        working-directory: /workdir
        run: |
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH immortalwrt
          ln -sf /workdir/immortalwrt $GITHUB_WORKSPACE/immortalwrt

      - name: 更新与安装 Feeds (处理源冲突)
        working-directory: /workdir/immortalwrt
        run: |
          ./scripts/feeds update -a
          # 如下载失败提示 Hash Mismatch，此处会报错。
          # 预先删除可能冲突的重复包
          rm -rf feeds/packages/net/smartdns
          rm -rf feeds/luci/applications/luci-app-smartdns
          ./scripts/feeds install -a

      - name: 自定义配置 (2G空间/插件/IPv6)
        working-directory: /workdir/immortalwrt
        run: |
          # 设置 x86-64 架构
          echo "CONFIG_TARGET_x86=y" >> .config
          echo "CONFIG_TARGET_x86_64=y" >> .config
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
          
          # 核心：设置 2G 剩余空间 (Rootfs 分区设为 2560MB)
          echo "CONFIG_TARGET_KERNEL_PARTSIZE=64" >> .config
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=2560" >> .config
          
          # 插件集成
          echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-smartdns=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-mwan3=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-ddns=y" >> .config
          echo "CONFIG_PACKAGE_ddns-scripts-cloudflare=y" >> .config
          
          # IPv6 支持
          echo "CONFIG_PACKAGE_ipv6helper=y" >> .config
          
          # 补全依赖并检查
          make defconfig

      - name: 下载软件包 (预下载防止 Hash Mismatch)
        working-directory: /workdir/immortalwrt
        run: |
          make download -j8 || make download -j1 V=s
          find dl -size -1k -exec ls -l {} \;
          find dl -size -1k -exec rm -f {} \;

      - name: 编译固件 (单线程模式规避 Code 2)
        working-directory: /workdir/immortalwrt
        run: |
          # 默认先尝试多线程加速
          make -j$(nproc) || make -j1 V=s
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt_x86_64_Fixed
          path: /workdir/immortalwrt/bin/targets/x86/64/*-combined-efi.img.gz
